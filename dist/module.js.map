{"version":3,"sources":["../src/module.js"],"names":["angular","_","$","moment","FileExport","MetricsPanelCtrl","transformDataToTable","tablePanelEditor","columnOptionsTab","TableRenderer","Drop","PercentageTablePanelCtrl","$scope","$injector","templateSrv","annotationsSrv","$sanitize","pageIndex","panelDefaults","targets","transform","database","pageSize","showHeader","styles","type","pattern","alias","dateFormat","unit","decimals","colors","colorMode","thresholds","columns","scroll","fontSize","sort","col","desc","panel","fields","defaults","events","on","onDataReceived","bind","onDataError","onInitEditMode","onInitPanelActions","addEditorTab","actions","push","text","click","datasource","setTimeQueryStart","getAnnotations","dashboard","range","then","data","annotations","err","dataRaw","render","dataList","length","result","error","Error","message","console","log","lengthSerieA","rows","lengthSerieB","maxLengthSeries","i","dataFirst","dataSecond","res","table","renderer","isTimezoneUtc","colIndex","exportTableDataToCsv","render_values","scope","elem","attrs","ctrl","pageCount","formaters","getTableHeight","panelHeight","height","appendTableRows","tbodyElem","setTable","empty","html","switchPage","e","el","currentTarget","parseInt","renderPanel","appendPaginationControls","footerElem","Math","ceil","startPage","max","endPage","min","paginationList","activeClass","pageLinkElem","append","panelElem","parents","rootElem","find","css","addClass","tooltip","selector","unbindDestroy","$on","off","renderData","renderingCompleted","templateUrl"],"mappings":"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","file":"module.js","sourcesContent":["///<reference path=\"../../../headers/common.d.ts\" />\r\n\r\nimport angular from 'angular';\r\nimport _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport moment from 'moment';\r\nimport * as FileExport from 'app/core/utils/file_export';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport {transformDataToTable} from './transformers';\r\nimport {tablePanelEditor} from './editor';\r\nimport {columnOptionsTab} from './column_options';\r\nimport {TableRenderer} from './renderer';\r\nimport Drop from 'tether-drop';\r\n\r\nclass PercentageTablePanelCtrl extends MetricsPanelCtrl {\r\n\r\n  /** @ngInject */\r\n  constructor($scope, $injector, templateSrv, annotationsSrv, $sanitize) {\r\n    super($scope, $injector);\r\n    this.pageIndex = 0;\r\n\r\n    this.panelDefaults = {\r\n        targets: [{}],\r\n        transform: 'timeseries_to_columns',\r\n        database: null,\r\n        pageSize: null,\r\n        showHeader: true,\r\n        styles: [\r\n          {\r\n            type: 'date',\r\n            pattern: 'Time',\r\n            alias: 'Time',\r\n            dateFormat: 'YYYY-MM-DD HH:mm:ss',\r\n          },\r\n          {\r\n            unit: 'short',\r\n            type: 'number',\r\n            alias: '',\r\n            decimals: 2,\r\n            colors: [\"rgba(245, 54, 54, 0.9)\", \"rgba(237, 129, 40, 0.89)\", \"rgba(50, 172, 45, 0.97)\"],\r\n            colorMode: null,\r\n            pattern: '/.*/',\r\n            thresholds: [],\r\n          }\r\n        ],\r\n        columns: [],\r\n        scroll: true,\r\n        fontSize: '100%',\r\n        sort: {col: 0, desc: true},\r\n      };\r\n\r\n    if (this.panel.styles === void 0) {\r\n      this.panel.styles = this.panel.columns;\r\n      this.panel.columns = this.panel.fields;\r\n      delete this.panel.columns;\r\n      delete this.panel.fields;\r\n    }\r\n\r\n    _.defaults(this.panel, this.panelDefaults);\r\n\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('init-panel-actions', this.onInitPanelActions.bind(this));\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('Options', tablePanelEditor, 2);\r\n    this.addEditorTab('Column Styles', columnOptionsTab, 3);\r\n  }\r\n\r\n  onInitPanelActions(actions) {\r\n    actions.push({text: 'Export CSV', click: 'ctrl.exportCsv()'});\r\n  }\r\n\r\n  issueQueries(datasource) {\r\n    this.pageIndex = 0;\r\n\r\n    if (this.panel.transform === 'annotations') {\r\n      this.setTimeQueryStart();\r\n      return this.annotationsSrv.getAnnotations({dashboard: this.dashboard, panel: this.panel, range: this.range})\r\n      .then(annotations => {\r\n        return {data: annotations};\r\n      });\r\n    }\r\n\r\n    return super.issueQueries(datasource);\r\n  }\r\n\r\n  onDataError(err) {\r\n    this.dataRaw = [];\r\n    this.render();\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n    this.dataRaw = dataList;\r\n    this.pageIndex = 0;\r\n\r\n    // automatically correct transform mode based on data\r\n    if (this.dataRaw && this.dataRaw.length) {\r\n      if (this.dataRaw[0].type === 'table') {\r\n        this.panel.transform = 'table';\r\n      } else {\r\n        if (this.dataRaw[0].type === 'docs') {\r\n          this.panel.transform = 'json';\r\n        } else {\r\n          if (this.panel.transform === 'table' || this.panel.transform === 'json') {\r\n            this.panel.transform = 'timeseries_to_rows';\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  handleQueryResult(result) {\r\n    if (result.data.length !== 2) {\r\n      let error = new Error();\r\n      error.message = 'Too many series error';\r\n      error.data = 'Metric query returns ' + result.data.length + ' series.\\nPercentage stat table panel expects two series.';\r\n      throw error;\r\n    }\r\n\r\n    if (!result.data[0].type || !result.data[1].type) {\r\n      console.log('\"FORMAT AS\" must be \"Table\" not \"Time series\"')\r\n      let error = new Error();\r\n      error.message = 'Wrong value for \"FORMAT AS\"';\r\n      error.data = '\"FORMAT AS\" must be \"Table\" not \"Time series\"';\r\n      throw error;\r\n    }\r\n\r\n\r\n    const lengthSerieA = result.data[0].rows.length;\r\n    const lengthSerieB = result.data[1].rows.length;\r\n    const maxLengthSeries = lengthSerieA > lengthSerieB ? lengthSerieA : lengthSerieB;\r\n\r\n    if (lengthSerieA !== lengthSerieB) {\r\n     let error = new Error();\r\n     error.message = 'Not same amount of data';\r\n     error.data = 'Serie A has ' + lengthSerieA + ' while Serie B has ' + lengthSerieB;\r\n     throw error;\r\n    }\r\n\r\n    for (let i = 0; i < maxLengthSeries; i++) {\r\n      const dataFirst = result.data[0].rows[i][2];\r\n      const dataSecond = result.data[1].rows[i][2] == 0 ? 1 : result.data[1].rows[i][2];\r\n      const res = (dataFirst / dataSecond) * 100;\r\n      result.data[0].rows[i][2] = res;\r\n    }\r\n    return super.handleQueryResult(result);\r\n  }\r\n\r\n  render() {\r\n    this.table = transformDataToTable(this.dataRaw, this.panel);\r\n    this.table.sort(this.panel.sort);\r\n    this.renderer = new TableRenderer(this.panel, this.table, this.dashboard.isTimezoneUtc(), this.$sanitize, this.templateSrv);\r\n\r\n    return super.render(this.table);\r\n  }\r\n\r\n  toggleColumnSort(col, colIndex) {\r\n    // remove sort flag from current column\r\n    if (this.table.columns[this.panel.sort.col]) {\r\n      this.table.columns[this.panel.sort.col].sort = false;\r\n    }\r\n\r\n    if (this.panel.sort.col === colIndex) {\r\n      if (this.panel.sort.desc) {\r\n        this.panel.sort.desc = false;\r\n      } else {\r\n        this.panel.sort.col = null;\r\n      }\r\n    } else {\r\n      this.panel.sort.col = colIndex;\r\n      this.panel.sort.desc = true;\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  exportCsv() {\r\n    FileExport.exportTableDataToCsv(this.renderer.render_values());\r\n  }\r\n\r\n  link(scope, elem, attrs, ctrl) {\r\n    var data;\r\n    var panel = ctrl.panel;\r\n    var pageCount = 0;\r\n    var formaters = [];\r\n\r\n    function getTableHeight() {\r\n      var panelHeight = ctrl.height;\r\n\r\n      if (pageCount > 1) {\r\n        panelHeight -= 26;\r\n      }\r\n\r\n      return (panelHeight - 31) + 'px';\r\n    }\r\n\r\n    function appendTableRows(tbodyElem) {\r\n      ctrl.renderer.setTable(data);\r\n      tbodyElem.empty();\r\n      tbodyElem.html(ctrl.renderer.render(ctrl.pageIndex));\r\n    }\r\n\r\n    function switchPage(e) {\r\n      var el = $(e.currentTarget);\r\n      ctrl.pageIndex = (parseInt(el.text(), 10)-1);\r\n      renderPanel();\r\n    }\r\n\r\n    function appendPaginationControls(footerElem) {\r\n      footerElem.empty();\r\n\r\n      var pageSize = panel.pageSize || 100;\r\n      pageCount = Math.ceil(data.rows.length / pageSize);\r\n      if (pageCount === 1) {\r\n        return;\r\n      }\r\n\r\n      var startPage = Math.max(ctrl.pageIndex - 3, 0);\r\n      var endPage = Math.min(pageCount, startPage + 9);\r\n\r\n      var paginationList = $('<ul></ul>');\r\n\r\n      for (var i = startPage; i < endPage; i++) {\r\n        var activeClass = i === ctrl.pageIndex ? 'active' : '';\r\n        var pageLinkElem = $('<li><a class=\"table-panel-page-link pointer ' + activeClass + '\">' + (i+1) + '</a></li>');\r\n        paginationList.append(pageLinkElem);\r\n      }\r\n\r\n      footerElem.append(paginationList);\r\n    }\r\n\r\n    function renderPanel() {\r\n      var panelElem = elem.parents('.panel');\r\n      var rootElem = elem.find('.table-panel-scroll');\r\n      var tbodyElem = elem.find('tbody');\r\n      var footerElem = elem.find('.table-panel-footer');\r\n\r\n      elem.css({'font-size': panel.fontSize});\r\n      panelElem.addClass('table-panel-wrapper');\r\n\r\n      appendTableRows(tbodyElem);\r\n      appendPaginationControls(footerElem);\r\n\r\n      rootElem.css({'max-height': panel.scroll ? getTableHeight() : '' });\r\n    }\r\n\r\n    // hook up link tooltips\r\n    elem.tooltip({\r\n      selector: '[data-link-tooltip]'\r\n    });\r\n\r\n    elem.on('click', '.table-panel-page-link', switchPage);\r\n\r\n    var unbindDestroy = scope.$on('$destroy', function() {\r\n      elem.off('click', '.table-panel-page-link');\r\n      unbindDestroy();\r\n    });\r\n\r\n    ctrl.events.on('render', function(renderData) {\r\n      data = renderData || data;\r\n      if (data) {\r\n        renderPanel();\r\n      }\r\n      ctrl.renderingCompleted();\r\n    });\r\n  }\r\n}\r\n\r\nPercentageTablePanelCtrl.templateUrl = 'module.html';\r\n\r\nexport {\r\n  PercentageTablePanelCtrl,\r\n  PercentageTablePanelCtrl as PanelCtrl\r\n};\r\n"]}